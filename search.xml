<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[rgw multisite最佳实践]]></title>
    <url>%2F2017%2F06%2F22%2F%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3rgw-multisite%2F</url>
    <content type="text"><![CDATA[前言 随着社区在jewel版对multisite进行重构，multisitev2作为全新的对象存储灾备特性了用户的视野。作为rgw集群整体数据灾备方案，从ceph社区来看，H3C和中移动苏州研究院等企业已经开始将此特性应用于产品中。 本文从以下八个方面对multisite进行介绍： 1. Multisite概念介绍 2. Multisite部署 3. Multisite原理介绍 4. 灾难发生时的故障处理 5. 已有单站点集群到多站点集群的迁移 6. 目前jewel 10.2.7版本multisite已知问题 7. 后续multisite社区发展方向 8. 参考资料 Multisite概念介绍 当前jewel版本multisite还只是简单实现Region内部多个s3集群的active/active及active/passive功能，无法实现bucket粒度级别的同步功能。 Zone: 一个逻辑的组概念，由一个或多个radosgw实例构成。ZongGroup中必须有一个Zone被设置成master Zone，负责处理所有的 bucket和用户的创建。 ZoneGroup:J版之前称为Region，目前被ZoneGroup替代，避免用户完全理解成AWS的Region概念。一个ZoneGroup不限于AWS的一个ragion片区，它可以跨越多个地理位置，并且简单的称为一组zone，也就是说，每个ZoneGroup内部都包含一个或多个Zone。rgw元数据在所有ZoneGroup之间同步。数据只能在ZoneGroup内部的Zone之间同步。 Period：Period保存当前的realm配置。每个period包含一个全局的id和时代。每个realm关联当前的period，并保存当前的配置状态。period只在ZoneGroup和Zone配置改变时更改。 Realms:realm作为全局命名空间，保存所有的ZoneGroup、Zone、period和bucket的元数据。 Multisite部署 在本文的部署例子中，我们以部署三个分别的Zone组成单个ZoneGroup为例，介绍Multisite的部署步骤。其中两个Zone属于相同的ceph cluster，第三个属于另外一个ceph cluster，它们共同组成了A/A的负载模式。 本例子由如下几个部分组成：1234 Master zonegroup: us Master zone：us-east-1 Secondary zone：us-east-2 Secondary zone: us-west 其中us-east-1与us-east-2所在同一个ceph cluster Master Zone配置 在配置multisite前，需要创建一个S3兼容的System key用户。rgw实例使用system user的access key和secret key来拉取远端multisite配置。 生成System user key的命令如下：12 SYSTEM_ACCESS_KEY=$(cat /dev/urandom | tr -dc &apos;a-zA-Z0-9&apos; | fold -w 20 | head -n 1) SYSTEM_SECRET_KEY=$(cat /dev/urandom | tr -dc &apos;a-zA-Z0-9&apos; | fold -w 40 | head -n 1) 将生成的SYSTEM_ACCESS_KEY和SYSTEM_SECRET_KEY存放到/etc/environment中 编辑environment：1 vim /etc/environment 内容如下：12 SYSTEM_ACCESS_KEY=上面生成的SYSTEM_ACCESS_KEY SYSTEM_SECRET_KEY=上面生成的SYSTEM_SECRET_KEY 使environment生效,1 source /etc/environment 通过下述命令创建pool,注意pg_num和pgp_num需要根据http://ceph.com/pgcalc/提前规划1ceph osd pool create ｛poolname｝｛pg_num｝ &#123;pgp_num&#125; replicated 需要在第一个ceph集群上创建如下几个pool，命名规则为zone-name.pool-name，创建其他zone时，可以通过替换us-east-1为其他zone的名字。1234567891011121314.rgw.rootus-east-1.rgw.controlus-east-1.rgw.data.rootus-east-1.rgw.gcus-east-1.rgw.logus-east-1.rgw.intent-logus-east-1.rgw.usageus-east-1.rgw.users.keysus-east-1.rgw.users.emailus-east-1.rgw.users.swiftus-east-1.rgw.users.uidus-east-1.rgw.buckets.indexus-east-1.rgw.buckets.dataus-east-1.rgw.meta 创建名字为gold的Realm，并设置为默认realm。命令为：radosgw-admin realm create –rgw-realm={realm-name} [–default]。如果指定–default，radosgw-admin会使用此realm作为默认relam。如果不指定–default，添加zonegroup和zone时，需要用–rgw-realm标志或–realm-id标志指定realm。1234567 radosgw-admin realm create --rgw-realm=gold --default &#123; &quot;id&quot;: &quot;4a367026-bd8f-40ee-b486-8212482ddcd7&quot;, &quot;name&quot;: &quot;gold&quot;, &quot;current_period&quot;: &quot;09559832-67a4-4101-8b3f-10dfcd6b2707&quot;, &quot;epoch&quot;: 1 &#125; 创建名字为us的Master Zonegroup。如果只有一个zonegroup，使用–default标志设置为默认zongroup，当添加新zone时radosgw-admin会使用此zonegroup作为默认的zonegroup。如果不设置–default，添加或修改zone时需要使用–rgw-zonegroup或–zonegroup-id指定zonegroup。1234567891011121314151617 radosgw-admin zonegroup create --rgw-zonegroup=us \--endpoints=http://rgw1:80 --master --default &#123; &quot;id&quot;: &quot;d4018b8d-8c0d-4072-8919-608726fa369e&quot;, &quot;name&quot;: &quot;us&quot;, &quot;api_name&quot;: &quot;us&quot;, &quot;is_master&quot;: &quot;true&quot;, &quot;endpoints&quot;: [ &quot;http:\/\/rgw1:80&quot; ], &quot;hostnames&quot;: [], &quot;hostnames_s3website&quot;: [], &quot;master_zone&quot;: &quot;&quot;, &quot;zones&quot;: [], &quot;placement_targets&quot;: [], &quot;default_placement&quot;: &quot;&quot;, &quot;realm_id&quot;: &quot;4a367026-bd8f-40ee-b486-8212482ddcd7&quot; 创建名字为us-east-1的zone并添加到默认zonegroup中。此zone主要负责user和bucket元数据管理123456789101112131415161718192021222324252627282930313233 radosgw-admin zone create --rgw-zonegroup=us --rgw-zone=us-east-1 \--endpoints=http://rgw1:80 --master --default --access-key=$SYSTEM_ACCESS_KEY --secret=$SYSTEM_SECRET_KEY &#123; &quot;id&quot;: &quot;83859a9a-9901-4f00-aa6d-285c777e10f0&quot;, &quot;name&quot;: &quot;us-east-1&quot;, &quot;domain_root&quot;: &quot;us-east-1/gc.rgw.data.root&quot;, &quot;control_pool&quot;: &quot;us-east-1/gc.rgw.control&quot;, &quot;gc_pool&quot;: &quot;us-east-1/gc.rgw.gc&quot;, &quot;log_pool&quot;: &quot;us-east-1/gc.rgw.log&quot;, &quot;intent_log_pool&quot;: &quot;us-east-1/gc.rgw.intent-log&quot;, &quot;usage_log_pool&quot;: &quot;us-east-1/gc.rgw.usage&quot;, &quot;user_keys_pool&quot;: &quot;us-east-1/gc.rgw.users.keys&quot;, &quot;user_email_pool&quot;: &quot;us-east-1/gc.rgw.users.email&quot;, &quot;user_swift_pool&quot;: &quot;us-east-1/gc.rgw.users.swift&quot;, &quot;user_uid_pool&quot;: &quot;us-east-1/gc.rgw.users.uid&quot;, &quot;system_key&quot;: &#123; &quot;access_key&quot;: &quot;1555b35654ad1656d804&quot;, &quot;secret_key&quot;: &quot;h7GhxuBLTrlhVUyxSPUKUV8r\/2EI4ngqJxD7iBdBYLhwluN30JaT3Q==&quot; &#125;, &quot;placement_pools&quot;: [ &#123; &quot;key&quot;: &quot;default-placement&quot;, &quot;val&quot;: &#123; &quot;index_pool&quot;: &quot;us-east-1/gc.rgw.buckets.index&quot;, &quot;data_pool&quot;: &quot;us-east-1/gc.rgw.buckets.data&quot;, &quot;data_extra_pool&quot;: &quot;us-east-1/gc.rgw.buckets.non-ec&quot;, &quot;index_type&quot;: 0 &#125; &#125; ], &quot;metadata_heap&quot;: &quot;us-east-1/gc.rgw.meta&quot;, &quot;realm_id&quot;: &quot;4a367026-bd8f-40ee-b486-8212482ddcd7&quot; &#125; 删除default zone和zone：123456 radosgw-admin zonegroup remove --rgw-zonegroup=default --rgw-zone=default radosgw-admin period update --commit radosgw-admin zone delete --rgw-zone=default radosgw-admin period update --commit radosgw-admin zonegroup delete --rgw-zonegroup=default radosgw-admin period update --commit 删除创建ceph cluster集群时的默认pool，注意如果默认pool中有数据需要先转移：12345 rados rmpool default.rgw.control default.rgw.control --yes-i-really-really-mean-it rados rmpool default.rgw.data.root default.rgw.data.root --yes-i-really-really-mean-it rados rmpool default.rgw.gc default.rgw.gc --yes-i-really-really-mean-it rados rmpool default.rgw.log default.rgw.log --yes-i-really-really-mean-it rados rmpool default.rgw.users.uid default.rgw.users.uid --yes-i-really-really-mean-it 创建System user。radosgw后台进程在拉取realm和period信息之前必须经过认证，因此需要在master zone创建system user：123 radosgw-admin user create --uid=zone.user \--display-name=&quot;Zone User&quot; --access-key=$SYSTEM_ACCESS_KEY \--secret=$SYSTEM_SECRET_KEY --system 提交Period变化：123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869 radosgw-admin period update --commit&#123; &quot;id&quot;: &quot;b5e4d3ec-2a62-4746-b479-4b2bc14b27d1&quot;, &quot;epoch&quot;: 1, &quot;predecessor_uuid&quot;: &quot;09559832-67a4-4101-8b3f-10dfcd6b2707&quot;, &quot;sync_status&quot;: [ &quot;[...]&quot; ], &quot;period_map&quot;: &#123; &quot;id&quot;: &quot;b5e4d3ec-2a62-4746-b479-4b2bc14b27d1&quot;, &quot;zonegroups&quot;: [ &#123; &quot;id&quot;: &quot;d4018b8d-8c0d-4072-8919-608726fa369e&quot;, &quot;name&quot;: &quot;us&quot;, &quot;api_name&quot;: &quot;us&quot;, &quot;is_master&quot;: &quot;true&quot;, &quot;endpoints&quot;: [ &quot;http:\/\/rgw1:80&quot; ], &quot;hostnames&quot;: [], &quot;hostnames_s3website&quot;: [], &quot;master_zone&quot;: &quot;83859a9a-9901-4f00-aa6d-285c777e10f0&quot;, &quot;zones&quot;: [ &#123; &quot;id&quot;: &quot;83859a9a-9901-4f00-aa6d-285c777e10f0&quot;, &quot;name&quot;: &quot;us-east-1&quot;, &quot;endpoints&quot;: [ &quot;http:\/\/rgw1:80&quot; ], &quot;log_meta&quot;: &quot;true&quot;, &quot;log_data&quot;: &quot;false&quot;, &quot;bucket_index_max_shards&quot;: 0, &quot;read_only&quot;: &quot;false&quot; &#125; ], &quot;placement_targets&quot;: [ &#123; &quot;name&quot;: &quot;default-placement&quot;, &quot;tags&quot;: [] &#125; ], &quot;default_placement&quot;: &quot;default-placement&quot;, &quot;realm_id&quot;: &quot;4a367026-bd8f-40ee-b486-8212482ddcd7&quot; &#125; ], &quot;short_zone_ids&quot;: [ &#123; &quot;key&quot;: &quot;83859a9a-9901-4f00-aa6d-285c777e10f0&quot;, &quot;val&quot;: 630926044 &#125; ] &#125;, &quot;master_zonegroup&quot;: &quot;d4018b8d-8c0d-4072-8919-608726fa369e&quot;, &quot;master_zone&quot;: &quot;83859a9a-9901-4f00-aa6d-285c777e10f0&quot;, &quot;period_config&quot;: &#123; &quot;bucket_quota&quot;: &#123; &quot;enabled&quot;: false, &quot;max_size_kb&quot;: -1, &quot;max_objects&quot;: -1 &#125;, &quot;user_quota&quot;: &#123; &quot;enabled&quot;: false, &quot;max_size_kb&quot;: -1, &quot;max_objects&quot;: -1 &#125; &#125;, &quot;realm_id&quot;: &quot;4a367026-bd8f-40ee-b486-8212482ddcd7&quot;, &quot;realm_name&quot;: &quot;gold&quot;, &quot;realm_epoch&quot;: 2&#125; 修改ceph配置文件，增加rgw_zone配置：12 [client.rgw.us-east-1] rgw_zone=us-east-1 重启rgw实例：1service radosgw restart id=rgw.&#123;hostname&#125; 创建Secondary Zone 在同一个ceph cluster的另一个rgw实例上创建第二个zone，命名为us-east-2。首先创建zone对应的pool,名称如下：12345678910111213us-east-2.rgw.controlus-east-2.rgw.data.rootus-east-2.rgw.gcus-east-2.rgw.logus-east-2.rgw.intent-logus-east-2.rgw.usageus-east-2.rgw.users.keysus-east-2.rgw.users.emailus-east-2.rgw.users.swiftus-east-2.rgw.users.uidus-east-2.rgw.buckets.indexus-east-2.rgw.buckets.dataus-east-2.rgw.meta 创建seco2dary zone的命令与primary zone相同，只是去掉master标志位：123456789101112131415161718192021222324252627282930313233radosgw-admin zone create --rgw-zonegroup=us --endpoints=http://rgw2:80 \--rgw-zone=us-east-2 --access-key=$SYSTEM_ACCESS_KEY --secret=$SYSTEM_SECRET_KEY&#123; &quot;id&quot;: &quot;950c1a43-6836-41a2-a161-64777e07e8b8&quot;, &quot;name&quot;: &quot;us-east-2&quot;, &quot;domain_root&quot;: &quot;us-east-2.rgw.data.root&quot;, &quot;control_pool&quot;: &quot;us-east-2.rgw.control&quot;, &quot;gc_pool&quot;: &quot;us-east-2.rgw.gc&quot;, &quot;log_pool&quot;: &quot;us-east-2.rgw.log&quot;, &quot;intent_log_pool&quot;: &quot;us-east-2.rgw.intent-log&quot;, &quot;usage_log_pool&quot;: &quot;us-east-2.rgw.usage&quot;, &quot;user_keys_pool&quot;: &quot;us-east-2.rgw.users.keys&quot;, &quot;user_email_pool&quot;: &quot;us-east-2.rgw.users.email&quot;, &quot;user_swift_pool&quot;: &quot;us-east-2.rgw.users.swift&quot;, &quot;user_uid_pool&quot;: &quot;us-east-2.rgw.users.uid&quot;, &quot;system_key&quot;: &#123; &quot;access_key&quot;: &quot;1555b35654ad1656d804&quot;, &quot;secret_key&quot;: &quot;h7GhxuBLTrlhVUyxSPUKUV8r\/2EI4ngqJxD7iBdBYLhwluN30JaT3Q==&quot; &#125;, &quot;placement_pools&quot;: [ &#123; &quot;key&quot;: &quot;default-placement&quot;, &quot;val&quot;: &#123; &quot;index_pool&quot;: &quot;us-east-2.rgw.buckets.index&quot;, &quot;data_pool&quot;: &quot;us-east-2.rgw.buckets.data&quot;, &quot;data_extra_pool&quot;: &quot;us-east-2.rgw.buckets.non-ec&quot;, &quot;index_type&quot;: 0 &#125; &#125; ], &quot;metadata_heap&quot;: &quot;us-east-2.rgw.meta&quot;, &quot;realm_id&quot;: &quot;815d74c2-80d6-4e63-8cfc-232037f7ff5c&quot;&#125; 更新period1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586radosgw-admin period update --commit&#123; &quot;id&quot;: &quot;b5e4d3ec-2a62-4746-b479-4b2bc14b27d1&quot;, &quot;epoch&quot;: 2, &quot;predecessor_uuid&quot;: &quot;09559832-67a4-4101-8b3f-10dfcd6b2707&quot;, &quot;sync_status&quot;: [ &quot;[...]&quot; ], &quot;period_map&quot;: &#123; &quot;id&quot;: &quot;b5e4d3ec-2a62-4746-b479-4b2bc14b27d1&quot;, &quot;zonegroups&quot;: [ &#123; &quot;id&quot;: &quot;d4018b8d-8c0d-4072-8919-608726fa369e&quot;, &quot;name&quot;: &quot;us&quot;, &quot;api_name&quot;: &quot;us&quot;, &quot;is_master&quot;: &quot;true&quot;, &quot;endpoints&quot;: [ &quot;http:\/\/rgw1:80&quot; ], &quot;hostnames&quot;: [], &quot;hostnames_s3website&quot;: [], &quot;master_zone&quot;: &quot;83859a9a-9901-4f00-aa6d-285c777e10f0&quot;, &quot;zones&quot;: [ &#123; &quot;id&quot;: &quot;83859a9a-9901-4f00-aa6d-285c777e10f0&quot;, &quot;name&quot;: &quot;us-east-1&quot;, &quot;endpoints&quot;: [ &quot;http:\/\/rgw1:80&quot; ], &quot;log_meta&quot;: &quot;true&quot;, &quot;log_data&quot;: &quot;false&quot;, &quot;bucket_index_max_shards&quot;: 0, &quot;read_only&quot;: &quot;false&quot; &#125;, &#123; &quot;id&quot;: &quot;950c1a43-6836-41a2-a161-64777e07e8b8&quot;, &quot;name&quot;: &quot;us-east-2&quot;, &quot;endpoints&quot;: [ &quot;http:\/\/rgw2:80&quot; ], &quot;log_meta&quot;: &quot;false&quot;, &quot;log_data&quot;: &quot;true&quot;, &quot;bucket_index_max_shards&quot;: 0, &quot;read_only&quot;: &quot;false&quot; &#125; ], &quot;placement_targets&quot;: [ &#123; &quot;name&quot;: &quot;default-placement&quot;, &quot;tags&quot;: [] &#125; ], &quot;default_placement&quot;: &quot;default-placement&quot;, &quot;realm_id&quot;: &quot;4a367026-bd8f-40ee-b486-8212482ddcd7&quot; &#125; ], &quot;short_zone_ids&quot;: [ &#123; &quot;key&quot;: &quot;83859a9a-9901-4f00-aa6d-285c777e10f0&quot;, &quot;val&quot;: 630926044 &#125;, &#123; &quot;key&quot;: &quot;950c1a43-6836-41a2-a161-64777e07e8b8&quot;, &quot;val&quot;: 4276257543 &#125; ] &#125;, &quot;master_zonegroup&quot;: &quot;d4018b8d-8c0d-4072-8919-608726fa369e&quot;, &quot;master_zone&quot;: &quot;83859a9a-9901-4f00-aa6d-285c777e10f0&quot;, &quot;period_config&quot;: &#123; &quot;bucket_quota&quot;: &#123; &quot;enabled&quot;: false, &quot;max_size_kb&quot;: -1, &quot;max_objects&quot;: -1 &#125;, &quot;user_quota&quot;: &#123; &quot;enabled&quot;: false, &quot;max_size_kb&quot;: -1, &quot;max_objects&quot;: -1 &#125; &#125;, &quot;realm_id&quot;: &quot;4a367026-bd8f-40ee-b486-8212482ddcd7&quot;, &quot;realm_name&quot;: &quot;gold&quot;, &quot;realm_epoch&quot;: 2&#125; 修改ceph.conf，增加rgw_zone配置12[client.rgw.us-east-2]rgw_zone=us-east-2 重启rgw网关1service radosgw restart id=rgw.&#123;hostname&#125; 第二个ceph cluster的Zone配置 拉取master zone的realm123456789radosgw-admin realm pull --url=http://rgw1:80 \--access-key=$SYSTEM_ACCESS_KEY --secret=$SYSTEM_SECRET_KEY&#123; &quot;id&quot;: &quot;4a367026-bd8f-40ee-b486-8212482ddcd7&quot;, &quot;name&quot;: &quot;gold&quot;, &quot;current_period&quot;: &quot;b5e4d3ec-2a62-4746-b479-4b2bc14b27d1&quot;, &quot;epoch&quot;: 2&#125;radosgw-admin realm default --rgw-realm=gold 拉取master zone的period12 radosgw-admin period pull --url=http://rgw1:80 \--access-key=$SYSTEM_ACCESS_KEY --secret=$SYSTEM_SECRET_KEY 设置默认的zonegroup1 radosgw-admin zonegroup default --rgw-zonegroup=us 创建zone对应的pools，名称如下：12345678910111213us-west.rgw.controlus-west.rgw.data.rootus-west.rgw.gcus-west.rgw.logus-west.rgw.intent-logus-west.rgw.usageus-west.rgw.users.keysus-west.rgw.users.emailus-west.rgw.users.swiftus-west.rgw.users.uidus-west.rgw.buckets.indexus-west.rgw.buckets.dataus-west.rgw.meta 创建名字为us-west的zone12345678910111213141516171819202122232425262728293031323334radosgw-admin zone create --rgw-zonegroup=us --rgw-zone=us-west \--access-key=$SYSTEM_ACCESS_KEY --secret=$SYSTEM_SECRET_KEY \--endpoints=http://rgw3:80 --default&#123; &quot;id&quot;: &quot;950c1a43-6836-41a2-a161-64777e07e8b8&quot;, &quot;name&quot;: &quot;us-west&quot;, &quot;domain_root&quot;: &quot;us-west.rgw.data.root&quot;, &quot;control_pool&quot;: &quot;us-west.rgw.control&quot;, &quot;gc_pool&quot;: &quot;us-west.rgw.gc&quot;, &quot;log_pool&quot;: &quot;us-west.rgw.log&quot;, &quot;intent_log_pool&quot;: &quot;us-west.rgw.intent-log&quot;, &quot;usage_log_pool&quot;: &quot;us-west.rgw.usage&quot;, &quot;user_keys_pool&quot;: &quot;us-west.rgw.users.keys&quot;, &quot;user_email_pool&quot;: &quot;us-west.rgw.users.email&quot;, &quot;user_swift_pool&quot;: &quot;us-west.rgw.users.swift&quot;, &quot;user_uid_pool&quot;: &quot;us-west.rgw.users.uid&quot;, &quot;system_key&quot;: &#123; &quot;access_key&quot;: &quot;1555b35654ad1656d804&quot;, &quot;secret_key&quot;: &quot;h7GhxuBLTrlhVUyxSPUKUV8r\/2EI4ngqJxD7iBdBYLhwluN30JaT3Q==&quot; &#125;, &quot;placement_pools&quot;: [ &#123; &quot;key&quot;: &quot;default-placement&quot;, &quot;val&quot;: &#123; &quot;index_pool&quot;: &quot;us-west.rgw.buckets.index&quot;, &quot;data_pool&quot;: &quot;us-west.rgw.buckets.data&quot;, &quot;data_extra_pool&quot;: &quot;us-west.rgw.buckets.non-ec&quot;, &quot;index_type&quot;: 0 &#125; &#125; ], &quot;metadata_heap&quot;: &quot;us-west.rgw.meta&quot;, &quot;realm_id&quot;: &quot;4a367026-bd8f-40ee-b486-8212482ddcd7&quot;&#125; 删除default zone和zone：123456 radosgw-admin zonegroup remove --rgw-zonegroup=default --rgw-zone=default radosgw-admin period update --commit radosgw-admin zone delete --rgw-zone=default radosgw-admin period update --commit radosgw-admin zonegroup delete --rgw-zonegroup=default radosgw-admin period update --commit 删除创建ceph cluster集群时的默认pool，注意如果默认pool中有数据需要先转移：12345 rados rmpool default.rgw.control default.rgw.control --yes-i-really-really-mean-it rados rmpool default.rgw.data.root default.rgw.data.root --yes-i-really-really-mean-it rados rmpool default.rgw.gc default.rgw.gc --yes-i-really-really-mean-it rados rmpool default.rgw.log default.rgw.log --yes-i-really-really-mean-it rados rmpool default.rgw.users.uid default.rgw.users.uid --yes-i-really-really-mean-it 提交更新的period:123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100radosgw-admin period update --commit --rgw-zone=us-west&#123; &quot;id&quot;: &quot;b5e4d3ec-2a62-4746-b479-4b2bc14b27d1&quot;, &quot;epoch&quot;: 3, &quot;predecessor_uuid&quot;: &quot;09559832-67a4-4101-8b3f-10dfcd6b2707&quot;, &quot;sync_status&quot;: [ &quot;&quot;, # truncated ], &quot;period_map&quot;: &#123; &quot;id&quot;: &quot;b5e4d3ec-2a62-4746-b479-4b2bc14b27d1&quot;, &quot;zonegroups&quot;: [ &#123; &quot;id&quot;: &quot;d4018b8d-8c0d-4072-8919-608726fa369e&quot;, &quot;name&quot;: &quot;us&quot;, &quot;api_name&quot;: &quot;us&quot;, &quot;is_master&quot;: &quot;true&quot;, &quot;endpoints&quot;: [ &quot;http:\/\/rgw1:80&quot; ], &quot;hostnames&quot;: [], &quot;hostnames_s3website&quot;: [], &quot;master_zone&quot;: &quot;83859a9a-9901-4f00-aa6d-285c777e10f0&quot;, &quot;zones&quot;: [ &#123; &quot;id&quot;: &quot;83859a9a-9901-4f00-aa6d-285c777e10f0&quot;, &quot;name&quot;: &quot;us-east-1&quot;, &quot;endpoints&quot;: [ &quot;http:\/\/rgw1:80&quot; ], &quot;log_meta&quot;: &quot;true&quot;, &quot;log_data&quot;: &quot;true&quot;, &quot;bucket_index_max_shards&quot;: 0, &quot;read_only&quot;: &quot;false&quot; &#125;, &#123; &quot;id&quot;: &quot;950c1a43-6836-41a2-a161-64777e07e8b8&quot;, &quot;name&quot;: &quot;us-east-2&quot;, &quot;endpoints&quot;: [ &quot;http:\/\/rgw2:80&quot; ], &quot;log_meta&quot;: &quot;false&quot;, &quot;log_data&quot;: &quot;true&quot;, &quot;bucket_index_max_shards&quot;: 0, &quot;read_only&quot;: &quot;false&quot; &#125;, &#123; &quot;id&quot;: &quot;d9522067-cb7b-4129-8751-591e45815b16&quot;, &quot;name&quot;: &quot;us-west&quot;, &quot;endpoints&quot;: [ &quot;http:\/\/rgw3:80&quot; ], &quot;log_meta&quot;: &quot;false&quot;, &quot;log_data&quot;: &quot;true&quot;, &quot;bucket_index_max_shards&quot;: 0, &quot;read_only&quot;: &quot;false&quot; &#125; ], &quot;placement_targets&quot;: [ &#123; &quot;name&quot;: &quot;default-placement&quot;, &quot;tags&quot;: [] &#125; ], &quot;default_placement&quot;: &quot;default-placement&quot;, &quot;realm_id&quot;: &quot;4a367026-bd8f-40ee-b486-8212482ddcd7&quot; &#125; ], &quot;short_zone_ids&quot;: [ &#123; &quot;key&quot;: &quot;83859a9a-9901-4f00-aa6d-285c777e10f0&quot;, &quot;val&quot;: 630926044 &#125;, &#123; &quot;key&quot;: &quot;950c1a43-6836-41a2-a161-64777e07e8b8&quot;, &quot;val&quot;: 4276257543 &#125;, &#123; &quot;key&quot;: &quot;d9522067-cb7b-4129-8751-591e45815b16&quot;, &quot;val&quot;: 329470157 &#125; ] &#125;, &quot;master_zonegroup&quot;: &quot;d4018b8d-8c0d-4072-8919-608726fa369e&quot;, &quot;master_zone&quot;: &quot;83859a9a-9901-4f00-aa6d-285c777e10f0&quot;, &quot;period_config&quot;: &#123; &quot;bucket_quota&quot;: &#123; &quot;enabled&quot;: false, &quot;max_size_kb&quot;: -1, &quot;max_objects&quot;: -1 &#125;, &quot;user_quota&quot;: &#123; &quot;enabled&quot;: false, &quot;max_size_kb&quot;: -1, &quot;max_objects&quot;: -1 &#125; &#125;, &quot;realm_id&quot;: &quot;4a367026-bd8f-40ee-b486-8212482ddcd7&quot;, &quot;realm_name&quot;: &quot;gold&quot;, &quot;realm_epoch&quot;: 2&#125; 修改ceph.conf，增加rgw_zone配置:12 [client.rgw.us-east-2] rgw_zone=us-west 重启rgw网关:1 service radosgw restart id=rgw.&#123;hostname&#125; 在第二个ceph集群上检查同步状态:12345678910111213 radosgw-admin sync status realm f3239bc5-e1a8-4206-a81d-e1576480804d (earth) zonegroup c50dbb7e-d9ce-47cc-a8bb-97d9b399d388 (us) zone 4c453b70-4a16-4ce8-8185-1893b05d346e (us-west) metadata sync syncing full sync: 0/64 shardsmetadata is caught up with master incremental sync: 64/64 shards data sync source: 1ee9da3e-114d-4ae3-a8a4-056e8a17f532 (us-east) syncing full sync: 0/128 shards incremental sync: 128/128 shards data is caught up with source Multisite原理介绍 本章节介绍了multisite一些主要概念的原理和组成，更加详细的设计原理请阅读本文末尾的参考资料。 Period和Realm介绍 每个peroid都有一个unique id。Period包含了realm配置，epoch和它之前period的id(除了第一个period)。可通过如下命令查看period的组成：12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485 radosgw-admin period get&#123; &quot;id&quot;: &quot;9c16dc3a-2c4c-418e-9332-857bfecbcc7b&quot;, &quot;epoch&quot;: 1, &quot;predecessor_uuid&quot;: &quot;5a57fda5-e21a-4ea3-a135-c5e8f6ef85d2&quot;, &quot;sync_status&quot;: [ &quot;&quot; ], &quot;period_map&quot;: &#123; &quot;id&quot;: &quot;9c16dc3a-2c4c-418e-9332-857bfecbcc7b&quot;, &quot;zonegroups&quot;: [ &#123; &quot;id&quot;: &quot;4e17988a-6d48-4030-a5b1-681fc218b8e0&quot;, &quot;name&quot;: &quot;cn&quot;, &quot;api_name&quot;: &quot;cn&quot;, &quot;is_master&quot;: &quot;true&quot;, &quot;endpoints&quot;: [ &quot;http:\/\/192.168.242.147:8080&quot; ], &quot;hostnames&quot;: [], &quot;hostnames_s3website&quot;: [], &quot;master_zone&quot;: &quot;4af832b3-02a5-4e44-8ff0-2e1d81a93b66&quot;, &quot;zones&quot;: [ &#123; &quot;id&quot;: &quot;4af832b3-02a5-4e44-8ff0-2e1d81a93b66&quot;, &quot;name&quot;: &quot;cn-sy-south&quot;, &quot;endpoints&quot;: [ &quot;http:\/\/192.168.242.147:8080&quot; ], &quot;log_meta&quot;: &quot;true&quot;, &quot;log_data&quot;: &quot;true&quot;, &quot;bucket_index_max_shards&quot;: 0, &quot;read_only&quot;: &quot;false&quot; &#125;, &#123; &quot;id&quot;: &quot;70ab0014-28f6-46cb-bd0f-68713268e657&quot;, &quot;name&quot;: &quot;cn-bj-east&quot;, &quot;endpoints&quot;: [ &quot;http:\/\/192.168.242.149:8080&quot; ], &quot;log_meta&quot;: &quot;false&quot;, &quot;log_data&quot;: &quot;true&quot;, &quot;bucket_index_max_shards&quot;: 0, &quot;read_only&quot;: &quot;false&quot; &#125; ], &quot;placement_targets&quot;: [ &#123; &quot;name&quot;: &quot;default-placement&quot;, &quot;tags&quot;: [] &#125; ], &quot;default_placement&quot;: &quot;default-placement&quot;, &quot;realm_id&quot;: &quot;03202997-3b9e-4455-a2dc-c1e442376589&quot; &#125; ], &quot;short_zone_ids&quot;: [ &#123; &quot;key&quot;: &quot;4af832b3-02a5-4e44-8ff0-2e1d81a93b66&quot;, &quot;val&quot;: 3422535981 &#125;, &#123; &quot;key&quot;: &quot;70ab0014-28f6-46cb-bd0f-68713268e657&quot;, &quot;val&quot;: 1669507347 &#125; ] &#125;, &quot;master_zonegroup&quot;: &quot;4e17988a-6d48-4030-a5b1-681fc218b8e0&quot;, &quot;master_zone&quot;: &quot;4af832b3-02a5-4e44-8ff0-2e1d81a93b66&quot;, &quot;period_config&quot;: &#123; &quot;bucket_quota&quot;: &#123; &quot;enabled&quot;: false, &quot;max_size_kb&quot;: -1, &quot;max_objects&quot;: -1 &#125;, &quot;user_quota&quot;: &#123; &quot;enabled&quot;: false, &quot;max_size_kb&quot;: -1, &quot;max_objects&quot;: -1 &#125; &#125;, &quot;realm_id&quot;: &quot;03202997-3b9e-4455-a2dc-c1e442376589&quot;, &quot;realm_name&quot;: &quot;earth&quot;, &quot;realm_epoch&quot;: 4&#125; 下述命令获取period的历史信息12345678910radosgw-admin period list&#123; &quot;periods&quot;: [ &quot;03202997-3b9e-4455-a2dc-c1e442376589:staging&quot;, &quot;3956f90a-6f67-4f7c-aba0-df2fc6600117&quot;, &quot;5a57fda5-e21a-4ea3-a135-c5e8f6ef85d2&quot;, &quot;9c16dc3a-2c4c-418e-9332-857bfecbcc7b&quot;, &quot;dc8661a1-b013-4a12-aa60-07025dbc5d38&quot; ] &#125; 每个realm关联当前的period，以及一列period历史信息123456789101112131415161718radosgw-admin realm get&#123; &quot;id&quot;: &quot;03202997-3b9e-4455-a2dc-c1e442376589&quot;, &quot;name&quot;: &quot;earth&quot;, &quot;current_period&quot;: &quot;9c16dc3a-2c4c-418e-9332-857bfecbcc7b&quot;, &quot;epoch&quot;: 4&#125;radosgw-admin realm list-periods&#123; &quot;current_period&quot;: &quot;9c16dc3a-2c4c-418e-9332-857bfecbcc7b&quot;, &quot;periods&quot;: [ &quot;9c16dc3a-2c4c-418e-9332-857bfecbcc7b&quot;, &quot;5a57fda5-e21a-4ea3-a135-c5e8f6ef85d2&quot;, &quot;3956f90a-6f67-4f7c-aba0-df2fc6600117&quot;, &quot;dc8661a1-b013-4a12-aa60-07025dbc5d38&quot; ]&#125; multisite配置设计成类似git的机制。用户配置存储在stagging period中，可以通过radosgw-adim period update命令更新period。multisite配置更改后，需要通过radosgw-admin period commit命令使其生效。 每个zone可以通过radosgw-admin period pull拉取配置。 Realm、Zonegroup和Zone的关系 每个realm中有一个或者多个zonegroup，其中有且只有一个master zonegroup。每个zonegroup有且只有一个master zone。元数据在Realm中的所有zone之间同步，数据只在Zonegroup内部的zone之间以A/A或A/P的方式同步。master zonegroup的master zone负责传播所有的配置改变。 Period解析 一个period是一个包括realm的配置状态，它包括这些zonegroup和zone的有效时期。 比如添加一个新zone或者修改endpoint地址，period依然与之前一样。但是会增加它的epoch，相当于相同period的新版本。 上图描述了period和epoch的关系。通过下列命令激活一个新的period或者增加epoch123 id=radosgw.am1 radosgw­admin ­­id $id zone create … radosgw­admin ­­id $id zone modify … 然后更新并提交period变化，新的配置会通过master zone传播到它的所有对端：1 radosgw­admin ­­id $id ­­rgw­realm=r10 period update ­­commit 所有的realm和period信息保存在ceph pool .rgw.root中。在同一个ceph集群的所有rgw进程或radosgw-admin cli可以很容易的获取信息。但是所有的rgw进程以及它们不同的zone使用不同的ceph集群时，情况会变得复杂一些。 在我们创建第二个zone时，会使用下列命令拉取realm和period配置1234 radosgw-admin realm pull --url=http://rgw1:80 \--access-key=$SYSTEM_ACCESS_KEY --secret=$SYSTEM_SECRET_KEY radosgw-admin period pull --url=http://rgw1:80 \--access-key=$SYSTEM_ACCESS_KEY --secret=$SYSTEM_SECRET_KEY 这两条命令会将period关联的信息从master zone传送到其他zone的集群。通过–url、–access-key和–scecet向master zone认证。 一旦realm和period的信息在新集群的.rgw.root pool建立后。后续不需要再进行pull操作，因为master zone会自动向所有对端更新配置变化。 另外，除了配置更改需要update和commit操作之外，其他操作都是自动传播和复制到其它zone。 例如使用下列命令创建一个s3用户，这个操作会自动同步到其他zone。注意只有在master zone gateway上执行的用户操作，才能自动传播到其他zone的ceph集群。12 id=radosgw.am1 radosgw­admin ­­id $id user create ­­uid=... bucket的创建也需要master zone进行提交操作，同步机制由zone之间内部完成。因此当master zone失效时，如果没有其它zone被提升为master zone，在这种情况下只能创建或者读写object，不能创建bucket。 另外注意一点，通常情况下使用多个Zone对应多个ceph集群，这是推荐的用法。但是也可以多个zone对应单个ceph集群，在这种情况下，这些zone必须在crushmap中是故障隔离的，并且集群内部的各个节点网络必须是低延迟。 灾难发生时的故障处理 本章我们讨论一下故障接管和故障回切(failback和failover)。通常情况下不需要进行集群间的故障接管和回切。例如： 对于硬件故障来说，负载均衡通常是高可用的 单独的radosgw gateway可能失效，但是它不会影响系统整体的崩溃 集群所有的数据和配置都是高可用的，没有单点故障。任何ceph集群的单个组件都可以失效也可以被恢复，不会导致任何的服务中断或者数据丢失。 考虑接管/回切的操作只有在灾难发生的情况下，也就是单个站点的完全失效。因此需要考虑如下两种情况： 单个站点临时不可用 单个站点长时间停机和服务失效 运维策略-站点临时不可用 通常情况下，由断电或者网络大规模故障导致的站点服务失效往往在几小时或者几天后会被恢复。 如果包含master zone的站点服务失效，其他站点仍然可以像通常一样提供读写请求服务，只是不能创建新的bucket和用户。在这种情况下，可以把应用的s3 url地址从失效站点替换为可用站点。 失效站点恢复后，简单的重启rgw实例即可，新启动的rgw实例会使用已经存在的配置并重新从其他zone的rgw实例同步。请注意，前提是没有将其他站点提升为主站点或者更改其他配置，以及失效站点没有数据丢失。 因为大部分的应用使用s3 api时，并不会创建全新的bucket，而仅仅使用一组静态的bucket。因此在站点临时失效时，这种处理方式是最稳妥的。 运维策略-站点长时间不可用以及数据丢失 当站点长期失效及大部分数据丢失时，其余站点会继续提供服务并保存运营。 如果失效站点是非master zone，我们不需要进行回切操作。因为master zone依然存在而且可操作，其余的站点可以提供所有的读写操作及创建bucket和s3用户操作。 如果失效站点是master zone，其余的站点可以提供读写服务。但是不能创建bucket和user。这时候应用应该将自己使用的s3 url连接配置到其他站点。 下一步应该仔细考虑，是否为了创建bucket和用户，提升一个非master zone为master zone。通常的策略是保持原状，直到无法避免。 接管操作(failed over) 提升在需要提升为master zone的ceph集群的管理节点执行下列配置，如果之前是A/P模式，还需要加上–read-only=False，允许数据读写:1 radosgw-admin zone modify --rgw-zone=&lt;zone-name&gt; --master --default --read-only=False 更新period，使配置生效。1 radosgw-admin period update --commit 此时不需要重启rgw服务，直接可以创建bucket或s3用户了。 回切操作(failed back) 如果原master zone恢复后，且之前的数据没有丢失。直接通过radosgw period pull获取新的period，然后通过上一节的接管操作步骤重新提升为master zone。 如果原master zone无法恢复及ceph集群完全损坏，则需要重建一个新的ceph cluster和zone。 第一步需要从master zone拉取realm和period到当前的空ceph集群，例如：12 radosgw­admin realm pull ­­url=&lt;rgw_endpoint&gt; ­­default ­­access=&lt;system_accesskey&gt; ­­secret=&lt;system_password&gt; radosgw­admin period pull ­­url=&lt;rgw_endpoint&gt; ­­access=&lt;system_accesskey&gt;­­secret=&lt;system_password&gt; 下一步，我们需要创建一个master zone，例如：1234 radosgw-admin zone create --rgw-zonegroup=&lt;zonegroup_name&gt; ＼--rgw-zone=&lt;zone_name&gt; --endpoints=&lt;rgw_endpoint&gt; --master --default ＼--access-key=&lt;system_accesskey&gt; --secret=&lt;system_password&gt; radosgw­admin period update ­­commit 第三步，把之前的master zone改为非master zone12 radosgw­admin zone modify ­­rgw­zone=&lt;zone_name&gt; ­­master=false radosgw­admin period update ­­commit 最后，把应用的s3 url恢复为原有的配置即可。 状态查看 赠送以下几个命令用于运维multisite。注意，有些命令执行时需要加一些额外参数，指定bucket、data等，请自行查询详细用法： sync error log查看 1 radosgw-admin sync error list log状态查看 123 radosgw-admin bilog status radosgw-admin datalog status radosgw-admin mdlog status 同步状态查看 123 radosgw-admin bucket sync status radosgw-admin data sync status radosgw-admin metadata sync status 全局重新resync触发 123 radosgw-admin bucket sync init radosgw-admin data sync init radosgw-admin metadata sync init 已有单站点集群到多站点集群的迁移 如何迁移已经部署的ceph rgw集群到multisite配置，参照如下几步： 首先在集群上创建realm1 radosgw-admin realm create --rgw-realm=&lt;name&gt; --default 重命名默认zone和zonegroup1234 radosgw-admin zonegroup rename --rgw-zonegroup \default --zonegroup-new-name=&lt;zonegroup_name&gt; radosgw-admin zone rename --rgw-zone default --zone-new-name &lt;zong_name&gt; \--rgw-zonegroup=&lt;name&gt; 配置master zonegroup的默认realm12 radosgw-admin zonegroup modify --rgw-realm=&lt;name&gt; --rgw-zonegroup=&lt;name&gt; \--endpoints &lt;rgw_endpoint&gt; --master --default 配置master zone的默认realm123 radosgw-admin zone modify --rgw-realm=&lt;name&gt; --rgw-zonegroup=&lt;name&gt; ＼ --rgw-zone=&lt;name&gt; --endpoints http://&lt;fqdn&gt;:80 --access-key=&lt;access-key&gt; ＼--secret=&lt;secret-key&gt; --master --default 创建system user12 radosgw-admin user create --uid=&lt;user-id&gt; --display-name=&quot;&lt;display-name&gt;&quot; \--access-key=&lt;access-key&gt; --secret=&lt;secret-key&gt; --system 更新配置1 radosgw-admin period update --commit 重启rgw服务1 service radosgw restart id=&lt;rgw.hostname&gt; 目前jewel 10.2.7版本multisite已知问题 未来multisite feature特性展望 bucket粒度同步特性 当前multisite还是以ceph集群整体为单位进行迁移，后续会提供类似公有云服务以bucket粒度进行数据同步的功能。例如AWS s3 CRR特性。由H3C公司开发，PR已经进入了review和unit test阶段。具体请见 https://github.com/ceph/ceph/pull/10995。 multisite框架支持插件 multisite在L版已经支持基于multisite机制的插件开发框架。rgw metadata search就是基于此开发的，同时一些开发人员基于此框架也开发了数据同步到其他对象存储的混合云存储功能。可以参考如下链接： rgw metadate feature：PR1，PR2，参考资料1，参考资料2 rgw数据同步到AWS：PR，参考资料 基于multisite plug实现混合云功能：参考资料 参考资料 1.Orit, Wasserman . Geo replication and disaster recovery for cloud object storage with Ceph rados gateway[Z]. LinuxCon EU: LinuxCon ,2016. 2.Walter, Graf . Understanding a Multi Site Ceph Gateway Installation[Z]. 2017. 3.温涛. 对象存储服务多站点功能分析[Z]. BeiJing: Ceph社区,2016. 4.朱荣泽. RGW multisite Overview[Z]. BeiJing: ceph社区,2016. 5.RedHat documentation 6.SuSe documentation]]></content>
      <categories>
        <category>ceph</category>
      </categories>
      <tags>
        <tag>rgw</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[博客搬家]]></title>
    <url>%2F2017%2F06%2F22%2F%E5%8D%9A%E5%AE%A2%E8%BF%81%E7%A7%BB%2F</url>
    <content type="text"><![CDATA[我的博客搬到github了。之前的旧文章可以在这里 查看。]]></content>
  </entry>
</search>